# üìÅ query classification agent.py
from langchain.prompts import ChatPromptTemplate
from langchain_core.prompts import HumanMessagePromptTemplate
from langchain_core.messages import SystemMessage, HumanMessage
from state_schema import (
    ClarificationResult,
    CategoryAssignment,
)
from taxonomy import norm, valid_pair, canonical_l1, canonical_l2
from llm_utils import get_together_llm,count_tokens
from settings import TOGETHER_MODEL
from pydantic import BaseModel, Field
from typing import List

# ---- LLM output schemas (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏≠‡πÄ‡∏à‡∏ô‡∏ï‡πå‡∏ô‡∏µ‡πâ) ----
class CategoryAssignmentOut(BaseModel):
    level_1: str = Field(..., description="‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô '‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£'")
    level_2: str = Field(..., description="EN ‡πÄ‡∏ä‡πà‡∏ô 'oral hygiene'")
    score: float = Field(..., ge=0.0, le=1.0)

class ClassificationLLMResult(BaseModel):
    categories: List[CategoryAssignmentOut] = Field(default_factory=list)

# -------- Clarify --------‡∏°
def check_clarity(user_query: str) -> ClarificationResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=ClarificationResult,
        temperature=0.1
    )
    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ß‡πà‡∏≤ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢

‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:
- `<task>` ‡∏Ñ‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô (Chain of Thought) ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏≤‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- `<criteria>` ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ `clarification_needed: true` ‡∏´‡∏£‡∏∑‡∏≠ `false` ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å task ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠
<task>
‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Chain of Thought (CoT) ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (short-circuit evaluation):

‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏´‡∏≤‡∏Å‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á (false)" ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ  
‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
  {"clarification_needed": true, "clarification_reason": "<‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô>"}
[‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)]
1. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏≠‡∏∞‡πÑ‡∏£, ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£, ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°, ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£, ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏´‡∏°, ‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á  
   - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà‚Äù, ‚Äú‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‚Äù ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°  
   ‚Üí ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô  
   ‚Üí clarification_reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°"

2. ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á **‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô, ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î, ‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô, ‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô, ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô, ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å, ‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å ‡∏Ø‡∏•‡∏Ø  
   - ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡πÅ‡∏Ñ‡πà‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ó‡∏≥‡∏ü‡∏±‡∏ô", "‡∏´‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏´‡∏°‡∏≠", "‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô", "‡∏ï‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏ã‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏∏‡∏î" ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ **‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡πÉ‡∏î** ‚Üí ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ **‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£**  
   - ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î‡∏î‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°" ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠  
   ‚Üí ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí ‡∏´‡∏¢‡∏∏‡∏î  
   ‚Üí clarification_reason: "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î ‡∏Ø‡∏•‡∏Ø"

3. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏±‡∏ô ‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å ‡πÄ‡∏à‡πá‡∏ö ‡∏õ‡∏ß‡∏î ‡πÅ‡∏ú‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏¢‡∏≤‡∏ä‡∏≤ ‡∏ö‡∏ß‡∏° ‡πÄ‡∏¢‡πá‡∏ö‡πÅ‡∏ú‡∏• ‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ü‡∏±‡∏ô  
   - ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó  
   - ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏õ‡∏ß‡∏î‚Äù, ‚Äú‡∏ä‡∏≤‚Äù, ‚Äú‡πÅ‡∏™‡∏ö‚Äù, ‚Äú‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‚Äù ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ú‡∏π‡∏Å‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   ‚Üí ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‚Üí ‡∏´‡∏¢‡∏∏‡∏î  
   ‚Üí clarification_reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°"

4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö 3 ‡∏Ç‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° + ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ + ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó) ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°  
   - ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ", "‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á", ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠  
   ‚Üí ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏´‡∏¢‡∏∏‡∏î  
   ‚Üí clarification_reason: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"

‡∏´‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 4 ‡∏Ç‡πâ‡∏≠ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
  {"clarification_needed": false}
‡πÄ‡∏°‡∏∑‡πà‡∏≠ "clarification_needed": true ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô clarification_reason ‡πÄ‡∏õ‡πá‡∏ô "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏¥‡∏ï‡∏£‡∏†‡∏≤‡∏û + ‡πÄ‡∏ä‡πá‡∏Å‡∏•‡∏¥‡∏™‡∏ï‡πå + ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á" ‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ (‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß):
- ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏û: "‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏ô‡∏∞‡∏Ñ‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö"
- ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)
- ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ö‡∏π‡∏•‡πÄ‡∏•‡πá‡∏ï 2‚Äì4 ‡∏Ç‡πâ‡∏≠ ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏ä‡πà‡∏ô:
  ‚Ä¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô/‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î/‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô/‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô)
  ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á/‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
  ‚Ä¢ ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö 0‚Äì10, ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ã‡∏∂‡∏°/‡∏ö‡∏ß‡∏°/‡∏°‡∏µ‡πÑ‡∏Ç‡πâ)
  ‚Ä¢ ‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà/‡πÅ‡∏û‡πâ‡∏¢‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
- ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢ "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢" 2‚Äì3 ‡∏Ç‡πâ‡∏≠ (‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á ‡πÄ‡∏ä‡πà‡∏ô
  ‚Ä¢ "‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î‡∏°‡∏≤ 24 ‡∏ä‡∏°. ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ã‡∏∂‡∏° ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏î‡∏µ?"
  ‚Ä¢ "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏°‡∏≤ 2 ‡∏ß‡∏±‡∏ô ‡∏õ‡∏ß‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö 6/10 ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏°‡πÉ‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏™‡∏±‡πà‡∏á?"
)

‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏™‡πÑ‡∏ï‡∏•‡πå:
- ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ï‡∏≥‡∏´‡∏ô‡∏¥ ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‚Äú‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö‚Äù ‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡πÑ‡∏î‡πâ
- ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô ~4 ‡∏ö‡∏π‡∏•‡πÄ‡∏•‡πá‡∏ï
- ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢/‡∏™‡∏±‡πà‡∏á‡∏¢‡∏≤‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô reason ‡∏ô‡∏µ‡πâ
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πà‡∏≤‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î/‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á/‡∏Å‡∏•‡∏∑‡∏ô‡∏•‡∏≥‡∏ö‡∏≤‡∏Å/‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏≥‡∏ö‡∏≤‡∏Å) ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ß‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
</task>

<criteria>
- ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡πÉ‡∏î ‚Äú‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‚Äù ‚Üí ‡∏ï‡∏≠‡∏ö:
  {
    "clarification_needed": true,
    "clarification_reason": "<‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö>"
  }

- ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 4 ‡∏Ç‡πâ‡∏≠ ‚Üí ‡∏ï‡∏≠‡∏ö:
  {
    "clarification_needed": false
  }
</criteria>

‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤ clarification_needed:
- [IN] ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
- [REASONING] ‡∏Ñ‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏±‡πâ‡∏á 4 ‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°, ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£, ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)
- [OUT] ‡∏Ñ‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ clarification_needed ‡πÅ‡∏•‡∏∞ clarification_reason

<examples>
[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏õ‡∏ß‡∏î"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ("‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô")
2. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
3. ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°)
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
[OUT] {"clarification_needed": false, "clarification_reason": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"}

[IN] "‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà"
[REASONING]
1. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤
2. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
3. ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
[OUT] {"clarification_needed": true, "clarification_reason": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£"}

[IN] "‡∏¢‡∏≤‡∏ä‡∏≤‡∏´‡∏°‡∏î‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡∏Ñ‡∏∞"  
[REASONING]  
1.‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°  
2.‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ("‡∏¢‡∏≤‡∏ä‡∏≤")  
3.‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£  
4.‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠  
[OUT] {"clarification_needed": true, "clarification_reason": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î ‡∏Ø‡∏•‡∏Ø"}
                      
[IN] "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°
2. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£)
3. ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
[OUT] {"clarification_needed": true, "clarification_reason": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£"}

[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ)
2. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
3. ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
[OUT] {"clarification_needed": false, "clarification_reason": "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö"}
</examples>

<format>
‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô:
{
  "clarification_needed": true | false,
  "clarification_reason": "string (‡πÉ‡∏™‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô true)"
}
</format>
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <format>"
        )
    ])
    chain = prompt | llm
    raw_output = chain.invoke({"user_query": user_query})
    if raw_output is None:
      return ClarificationResult(clarification_needed=True,
                                clarification_reason="‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ñ‡πà‡∏∞")
    if isinstance(raw_output, dict):
      if "clarification_reason" not in raw_output and "reason" in raw_output:
          raw_output["clarification_reason"] = raw_output.pop("reason")
      return ClarificationResult(**raw_output)
    return raw_output


def classify_categories(user_query: str) -> List[CategoryAssignment]:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=ClassificationLLMResult,
        temperature=0.1
    )

    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°  
‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å (`category_level_1`) ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (`category_level_2`) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (confidence)
                      
‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
- ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏≠‡∏≠‡∏Å‡∏°‡∏≤
- ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <format> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å whitelist ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡∏°‡πà/‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏∞‡∏Å‡∏î‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô/‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å-‡πÉ‡∏´‡∏ç‡πà
- 1 ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏π‡πà (‡πÇ‡∏î‡∏¢‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 3 ‡∏Ñ‡∏π‡πà) ‡πÅ‡∏•‡∏∞ level_2 ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö level_1
                      
<‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö (category_level_1)>
- "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£"
- "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô"  
- "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£"

<whitelist ‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (category_level_2) ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - "extraction"
    - "surgical removal of impacted teeth"
    - "dental implant surgery"
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô:
    - "Physical Symptoms"
    - "Digestive and Body Reactions"
    - "Wound and Infection"
    - "Respiratory and Throat"
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - "all rounded post op instruction"
    - "sleeping"
    - "drinking straw"
    - "smoking"
    - "alcohol"
    - "workout"
    - "food"
    - "oral hygiene"
    - "compression"
    - "medicine"
- ‡πÉ‡∏ä‡πâ string ‡πÉ‡∏´‡πâ ‚Äú‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏™‡πÅ‡∏•‡∏ä/‡∏™‡∏∞‡∏Å‡∏î‡∏ï‡πà‡∏≤‡∏á/‡πÄ‡∏Ñ‡∏™‡∏ï‡πà‡∏≤‡∏á
<category_level_2 definitions>
- extraction: ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô
- surgical removal of impacted teeth: ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ô‡∏≥‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î‡∏≠‡∏≠‡∏Å
- dental implant surgery: ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡∏ù‡∏±‡∏á‡∏£‡∏≤‡∏Å‡πÄ‡∏ó‡∏µ‡∏¢‡∏°
- Physical Symptoms: ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î ‡∏ö‡∏ß‡∏° ‡∏ä‡∏≤ ‡∏ï‡∏∂‡∏á
- Digestive and Body Reactions: ‡∏õ‡∏è‡∏¥‡∏Å‡∏¥‡∏£‡∏¥‡∏¢‡∏≤‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö/‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏™‡πâ ‡πÄ‡∏ß‡∏µ‡∏¢‡∏ô‡∏´‡∏±‡∏ß ‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏•‡∏µ‡∏¢
- Wound and Infection: ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ú‡∏•/‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ú‡∏•/‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠
- Respiratory and Throat: ‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏ô‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏≠ ‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠ ‡πÄ‡∏™‡∏°‡∏´‡∏∞ ‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡∏•‡∏≥‡∏ö‡∏≤‡∏Å
- all rounded post op instruction: ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥
- sleeping: ‡∏ß‡∏¥‡∏ò‡∏µ/‡∏ó‡πà‡∏≤‡∏ô‡∏≠‡∏ô/‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡∏∏‡∏ô‡∏´‡∏°‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥
- drinking straw: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î‡∏î‡∏π‡∏î
- smoking: ‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ö‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà/‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà‡πÑ‡∏ü‡∏ü‡πâ‡∏≤
- alcohol: ‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
- workout: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢/‡∏¢‡∏Å‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡∏±‡∏Å
- food: ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£/‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£
- oral hygiene: ‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å
- compression: ‡∏Å‡∏±‡∏î‡∏ú‡πâ‡∏≤‡∏Å‡πä‡∏≠‡∏ã/‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Ñ‡∏ö‡∏Å‡∏î
- medicine: ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î/‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞/‡∏¢‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÜ

<‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î>
- ‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° 1 ‡∏Ç‡πâ‡∏≠ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- confidence ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0.0 - 1.0

<hints>
- ‡∏ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á ‚Äú‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î‚Äù ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏Ñ‡∏π‡πà‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢: level_1="‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", level_2="surgical removal of impacted teeth"
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏≤‡∏°‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ (‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡∏´‡∏•‡∏≠‡∏î ‡∏ö‡∏∏‡∏´‡∏£‡∏µ‡πà ‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á ‡∏ô‡∏≠‡∏ô ‡∏õ‡∏£‡∏∞‡∏Ñ‡∏ö ‡∏¢‡∏≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£) ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Äú‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‚Äù ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å level_2 ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á
- ‡∏ñ‡πâ‡∏≤‡∏û‡∏π‡∏î‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏õ‡∏ß‡∏î ‡∏ö‡∏ß‡∏° ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠ ‡πÄ‡∏à‡πá‡∏ö‡∏Ñ‡∏≠ ‡πÑ‡∏≠ ‡∏Ø‡∏•‡∏Ø) ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏° ‚Äú‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å level_2 ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
<format>
{
  "categories": [
    {"level_1": "<‡πÑ‡∏ó‡∏¢‡∏ï‡∏≤‡∏° whitelist>", "level_2": "<‡∏ï‡∏≤‡∏° whitelist>", "score": 0.0-1.0},
    ...
  ]
}
</format>
                      
<examples>
[IN] "‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î‡∏°‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô ‡∏õ‡∏ß‡∏î‡πÄ‡∏¢‡∏≠‡∏∞ ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î‡∏î‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°"
[OUT]
{
  "categories": [
    {"level_1": "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "surgical removal of impacted teeth", "score": 0.88},
    {"level_1": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "level_2": "Physical Symptoms", "score": 0.86},
    {"level_1": "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "drinking straw", "score": 0.93}
  ]
}

[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏ã‡∏∂‡∏°‡∏ï‡∏•‡∏≠‡∏î ‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á"
[OUT]
{
  "categories": [
    {"level_1": "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "extraction", "score": 0.86},
    {"level_1": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "level_2": "Wound and Infection", "score": 0.90},
    {"level_1": "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "compression", "score": 0.84}
  ]
}

[IN] "‡∏ó‡∏≥‡∏£‡∏≤‡∏Å‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏°‡∏≤ ‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏≠‡∏±‡∏Å‡πÄ‡∏™‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ"
[OUT]
{
  "categories": [
    {"level_1": "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "dental implant surgery", "score": 0.90},
    {"level_1": "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "oral hygiene", "score": 0.88},
    {"level_1": "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "level_2": "medicine", "score": 0.85}
  ]
}
</examples>
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <format> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"
        )
    ])

    chain = prompt | llm
    llm_out: ClassificationLLMResult = chain.invoke({"user_query": user_query})
    if not llm_out or not llm_out.categories:
        return []

    # map ‚Üí CategoryAssignment (‡∏™‡∏Ñ‡∏µ‡∏°‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô state) + ‡πÉ‡∏™‡πà source="clf_v2"
    # ‡∏û‡∏£‡πâ‡∏≠‡∏° dedupe ‡πÇ‡∏î‡∏¢‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏π‡πà
    best = {}
    for it in llm_out.categories or []:
        l1_raw, l2_raw = it.level_1, it.level_2

        # normalize + canonicalize
        l1c = canonical_l1(norm(l1_raw))
        l2c = canonical_l2(norm(l2_raw))

        if not valid_pair(l1c, l2c):
            print("[clf][DROP invalid_pair]", repr(l1_raw), "‚Üí", l1c, "|", repr(l2_raw), "‚Üí", l2c)
            continue

        k = f"{l1c}|{l2c}"
        if (k not in best) or (it.score > best[k].score):
            best[k] = CategoryAssignment(
                level_1=l1c,
                level_2=l2c,
                score=it.score,
                source=TOGETHER_MODEL,
            )

    # ‡∏Ñ‡∏∑‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (state validator ‡∏à‡∏∞‡∏ó‡∏≥ threshold/‡∏à‡∏±‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô)
    return sorted(best.values(), key=lambda x: x.score, reverse=True)
