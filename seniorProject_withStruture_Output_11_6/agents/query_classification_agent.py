# üìÅ agent.py
from langchain.prompts import ChatPromptTemplate
from langchain_core.prompts import HumanMessagePromptTemplate
from langchain_core.messages import SystemMessage, HumanMessage
from state_schema import (
    AgentState,
    ClassificationResult,
    CategoryScore,
    SubcategoryScore,
    OutOfDomainResult,
    ClarificationResult,
    CategoryResult
)
from utils.llm_utils import get_together_llm
from pydantic import BaseModel
from typing import List
from config.settings import TOGETHER_MODEL
import time
from utils.llm_utils import count_tokens

CATEGORY_SUBCATEGORY_MAPPING = {
    "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£": {"‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤"},
    "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô": {"overall", "bleeding", "pain", "wound healing"},
    "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£": {"overall", "drinking straw", "alcohol", "workout", "food", "oral hygiene"}
}
CONFIDENCE_THRESHOLD = 0.4
def filter_invalid_categories(category_result):
    # ‡∏Å‡∏£‡∏≠‡∏á category_level_1
    valid_level_1 = [
        cat for cat in category_result.category_level_1
        if cat.confidence >= CONFIDENCE_THRESHOLD and cat.category in CATEGORY_SUBCATEGORY_MAPPING
    ]

    # ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
    valid_main_categories = {cat.category for cat in valid_level_1}

    # ‡∏Å‡∏£‡∏≠‡∏á category_level_2 ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å + confidence ‡∏ú‡πà‡∏≤‡∏ô
    valid_level_2 = [
        sub for sub in category_result.category_level_2
        if sub.confidence >= CONFIDENCE_THRESHOLD and any(
            sub.subcategory in CATEGORY_SUBCATEGORY_MAPPING[main_cat]
            for main_cat in valid_main_categories
        )
    ]

    # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    category_result.category_level_1 = valid_level_1
    category_result.category_level_2 = valid_level_2
    return category_result


from langchain_core.prompts import HumanMessagePromptTemplate

def check_out_of_domain(user_query: str) -> OutOfDomainResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=OutOfDomainResult,
        temperature=0.1
    )
    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
<task>
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå  
‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö "‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (out_of_domain: true)

</task>

<context>
‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö **‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°**  
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï ‡πÄ‡∏ä‡πà‡∏ô:
- ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô
- ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î ‡πÅ‡∏ú‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏´‡∏• ‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß
- ‡∏¢‡∏≤‡∏ä‡∏≤ ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤
- ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î
- ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°:
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏ô
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô noise ‡πÄ‡∏ä‡πà‡∏ô "123456", "asdfgh", ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ ‡∏Ø‡∏•‡∏Ø
</context>

<scope_schema>
<‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£

<‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏≤‡∏ä‡∏≤
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô:
    - overall, bleeding, pain, wound healing
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - overall, drinking straw, alcohol, workout, food, oral hygiene
</scope_schema>

<examples_in_scope>
- ‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ
- ‡πÅ‡∏ú‡∏•‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô
- ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
- ‡∏¢‡∏≤‡∏ä‡∏≤‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
- ‡∏¢‡∏≤‡∏ä‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏§‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà
</examples_in_scope>

<examples_out_of_scope>
- ‡∏ü‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∞‡πÑ‡∏£
- ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- ‡∏à‡∏∞‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ
- ws;vgg?
- üôÉüôÉüôÉ
</examples_out_of_scope>

<guideline>
‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö Reasoning:
1. ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô" ‚Üí ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
2. ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" ‚Üí ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
3. ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå" ‚Üí ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
‚Üí ‡∏™‡∏£‡∏∏‡∏õ: ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (false)

‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô:
- ‡∏ñ‡πâ‡∏≤ **‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ** ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô `<scope_schema>` ‚Üí `out_of_domain: false`
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏£‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‚Üí `out_of_domain: true`
- ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô", "‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô" ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ out_of_domain: true
- ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ out_of_domain: true
**‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á ‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô**
- ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏û‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï: "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô", "‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î", "‡∏¢‡∏≤‡∏ä‡∏≤", "‡∏õ‡∏ß‡∏î", "‡πÅ‡∏ú‡∏•", "‡πÄ‡∏•‡∏∑‡∏≠‡∏î", "‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
</guideline>

<output_format>
{
  "out_of_domain": true | false,
  "reason": "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô' ‡πÅ‡∏•‡∏∞ '‡∏¢‡∏≤‡∏ä‡∏≤' ‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"
}
</output_format>
<examples>                      
[IN] ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå  
[OUT] {"out_of_domain": false, "reason": "‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô' ‡πÅ‡∏•‡∏∞ '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' ‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"}
[IN] ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå  
[OUT] {"out_of_domain": false, "reason": "‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"}
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô reasoning ‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <output_format>"
        )
    ])
    chain = prompt | llm
    return chain.invoke({"user_query": user_query})


# ‚úÖ Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
def check_clarity(user_query: str) -> ClarificationResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=ClarificationResult,
        temperature=0.1
    )

    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ß‡πà‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

<task>
‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Chain of Thought (CoT) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤:
1. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡πâ‡∏ô‡∏°‡∏µ "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
2. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ "‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°" ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£ ‡∏õ‡∏ß‡∏î ‡πÅ‡∏ú‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏Ø‡∏•‡∏Ø
3. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö
</task>

<criteria>
- ‡∏´‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á 3 ‡∏Ç‡πâ‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô "‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á" ‚Üí ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ {"clarification_needed": false}
- ‡∏´‡∏≤‡∏Å‡∏Ç‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠ (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£, ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°) ‚Üí ‡∏ï‡∏≠‡∏ö {"clarification_needed": true}

</criteria>

<examples>
[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏õ‡∏ß‡∏î"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ("‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô")
2. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°)
3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
[OUT] {"clarification_needed": false, "reason": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"}

[IN] "‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà"
[REASONING]
1. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤
2. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏à‡πá‡∏ö‡∏à‡∏≤‡∏Å‡∏≠‡∏∞‡πÑ‡∏£)
3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠
[OUT] {"clarification_needed": true, "reason": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô"}

[IN] "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°
2. ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏•‡∏¢ (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤)
3. ‡∏à‡∏∂‡∏á‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
[OUT] {"clarification_needed": true, "reason": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°"}

[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á"
[REASONING]
1. ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
2. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
3. ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
[OUT] {"clarification_needed": false, "reason": "‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ñ‡∏£‡∏ö"}
</examples>

<format>
‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON:
{
  "clarification_needed": true | false,
  "reason": "‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•"
}
</format>
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <format>"
        )
    ])
    chain = prompt | llm
    return chain.invoke({"user_query": user_query})

# ‚úÖ Step 3: ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
def classify_categories(user_query: str) -> CategoryResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=CategoryResult,
        temperature=0.1
    )
    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°  
‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å (`category_level_1`) ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (`category_level_2`) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (confidence)

<‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö (category_level_1)>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£

<‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (category_level_2) ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô:
    - overall
    - bleeding
    - pain
    - wound healing
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - overall
    - drinking straw
    - alcohol
    - workout
    - food
    - oral hygiene

<category_level_2 definitions>
- ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏≤‡∏ä‡∏≤
- overall (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô): ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡∏ß‡∏° ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏î
- bleeding: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏´‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î
- pain: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
- wound healing: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏•‡∏´‡∏≤‡∏¢ ‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡∏•‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà ‡∏´‡∏≤‡∏¢‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- overall (‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£): ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- drinking straw: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î
- alcohol: ‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
- workout: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢
- food: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ/‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á ‡πÄ‡∏ú‡πá‡∏î ‡∏£‡πâ‡∏≠‡∏ô
- oral hygiene: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å
</category_level_2 definitions>

<‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î>
- ‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° 1 ‡∏Ç‡πâ‡∏≠ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- confidence ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0.0 - 1.0

<format>
{
  "category_level_1": [
    {"category": "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å", "confidence": 0.0 - 1.0},
    ...
  ],
  "category_level_2": [
    {"subcategory": "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢", "confidence": 0.0 - 1.0},
    ...
  ]
}
</format>

<‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á>
[IN] ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏ß‡∏î‡∏°‡∏≤‡∏Å ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?
[OUT]
{
  "category_level_1": [
    {"category": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "confidence": 0.93},
    {"category": "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "confidence": 0.91}
  ],
  "category_level_2": [
    {"subcategory": "pain", "confidence": 0.91},
    {"subcategory": "food", "confidence": 0.88}
  ]
}
[IN] ‡πÅ‡∏ú‡∏•‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏™‡∏ô‡∏¥‡∏ó‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô?
[OUT]
{
  "category_level_1": [{"category": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "confidence": 0.91}],
  "category_level_2": [{"subcategory": "wound healing", "confidence": 0.90}]
}
[IN] ‡πÅ‡∏ú‡∏•‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô
[OUT]
{
  "category_level_1": [{"category": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "confidence": 0.90}],
  "category_level_2": [{"subcategory": "wound healing", "confidence": 0.89}]
}
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° schema ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î"
        )
    ])
    chain = prompt | llm
    raw_result = chain.invoke({"user_query": user_query})
    filtered_result = filter_invalid_categories(raw_result)
    return filtered_result

# ‚úÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô pipeline
def run_classification_pipeline(state: AgentState) -> AgentState:
    latency_info = {}

    print("üö¶ Step 1: Out-of-Domain Check")
    start = time.perf_counter()
    ood_result = check_out_of_domain(state.user_query)
    print("‚úÖ Out-of-Domain Result:", ood_result)
    if ood_result is None or ood_result.out_of_domain is None:
        state.classification_result.out_of_domain = True
        state.response = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ"
        state.latency = latency_info
        return state
    latency_info["out_of_domain"] = round(time.perf_counter() - start, 3)
    latency_info["tokens_out_of_domain"] = count_tokens(state.user_query, model=TOGETHER_MODEL)
    state.classification_result.out_of_domain = ood_result.out_of_domain
    if state.should_terminate():
        state.latency = latency_info
        return state

    print("üîç Step 2: Clarity Check")
    start = time.perf_counter()
    clarity_result = check_clarity(state.user_query)
    latency_info["clarification"] = round(time.perf_counter() - start, 3)
    latency_info["tokens_clarification"] = count_tokens(state.user_query, model=TOGETHER_MODEL)
    state.classification_result.clarification_needed = clarity_result.clarification_needed
    if state.should_terminate():
        state.latency = latency_info
        return state

    print("üìä Step 3: Category Classification")
    start = time.perf_counter()
    category_result = classify_categories(state.user_query)
    latency_info["classification"] = round(time.perf_counter() - start, 3)
    latency_info["tokens_classification"] = count_tokens(state.user_query, model=TOGETHER_MODEL)
    state.classification_result.category_level_1 = category_result.category_level_1
    state.classification_result.category_level_2 = category_result.category_level_2
    state.latency = latency_info
    return state
