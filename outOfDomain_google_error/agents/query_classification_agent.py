# üìÅ agent.py
from langchain.prompts import ChatPromptTemplate
from langchain_core.prompts import HumanMessagePromptTemplate
from langchain_core.messages import SystemMessage, HumanMessage
from state_schema import (
    AgentState,
    ClassificationResult,
    CategoryScore,
    SubcategoryScore,
    OutOfDomainResult,
    ClarificationResult,
    CategoryResult
)
from utils.llm_utils import get_together_llm
from pydantic import BaseModel
from typing import List
from config.settings import TOGETHER_MODEL
import time
from utils.llm_utils import count_tokens

CATEGORY_SUBCATEGORY_MAPPING = {
    "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£": {"‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤"},
    "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô": {"overall", "bleeding", "pain", "wound healing"},
    "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£": {"overall", "drinking straw", "alcohol", "workout", "food", "oral hygiene"}
}
CONFIDENCE_THRESHOLD = 0.4
def filter_invalid_categories(category_result):
    # ‡∏Å‡∏£‡∏≠‡∏á category_level_1
    valid_level_1 = [
        cat for cat in category_result.category_level_1
        if cat.confidence >= CONFIDENCE_THRESHOLD and cat.category in CATEGORY_SUBCATEGORY_MAPPING
    ]

    # ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà
    valid_main_categories = {cat.category for cat in valid_level_1}

    # ‡∏Å‡∏£‡∏≠‡∏á category_level_2 ‡πÉ‡∏´‡πâ‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å + confidence ‡∏ú‡πà‡∏≤‡∏ô
    valid_level_2 = [
        sub for sub in category_result.category_level_2
        if sub.confidence >= CONFIDENCE_THRESHOLD and any(
            sub.subcategory in CATEGORY_SUBCATEGORY_MAPPING[main_cat]
            for main_cat in valid_main_categories
        )
    ]

    # ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
    category_result.category_level_1 = valid_level_1
    category_result.category_level_2 = valid_level_2
    return category_result


from langchain_core.prompts import HumanMessagePromptTemplate

def check_out_of_domain(user_query: str) -> OutOfDomainResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=OutOfDomainResult,
        temperature=0.1
    )
    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏≥‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ô `<task>`  
‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏à‡∏≤‡∏Å `<criteria>` ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å `<scope_schema>`, `<examples_in_scope>`, `<examples_out_of_scope>`, `<guideline>`, `<output_format>`, ‡πÅ‡∏•‡∏∞ `<examples>` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ß‡πà‡∏≤  
"‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ tag ‡∏°‡∏µ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
- `<task>`: ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö "‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (`out_of_domain: true`)
- `<criteria>`: ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö **‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°** ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
- `<scope_schema>`: ‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö **‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï** ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏ä‡∏≤), ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î ‡πÅ‡∏ú‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î), ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢)
- `<examples_in_scope>`: ‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ **‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï** ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
- `<examples_out_of_scope>`: ‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà **‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï** ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≤‡∏∞‡∏à‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏•‡∏¢
- `<guideline>`: ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ **‡∏´‡∏•‡∏±‡∏Å reasoning ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î** ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô", "‡πÅ‡∏ú‡∏•", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏¢‡∏≤‡∏ä‡∏≤" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï  
  ‡πÅ‡∏ï‡πà‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ ‚Üí ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
- `<output_format>`: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÇ‡∏î‡∏¢‡∏°‡∏µ 2 ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:
  - `out_of_domain`: ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (`true` ‡∏´‡∏£‡∏∑‡∏≠ `false`)
  - `reason`: ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡πÑ‡∏°‡∏à‡∏∂‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏à‡∏£‡∏¥‡∏á ‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏á
- `<examples>`: ‡∏£‡∏ß‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á input/output ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà
                                                              
<task>
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå  
‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö "‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (out_of_domain: true)

</task>

<context>
‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö **‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°**  
‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï ‡πÄ‡∏ä‡πà‡∏ô:
- ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô
- ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏õ‡∏ß‡∏î ‡πÅ‡∏ú‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏´‡∏• ‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß
- ‡∏¢‡∏≤‡∏ä‡∏≤ ‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏õ‡∏ß‡∏î ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤
- ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏ó‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- ‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î
- ‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°
‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°:
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ü‡∏±‡∏ô
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô noise ‡πÄ‡∏ä‡πà‡∏ô "123456", "asdfgh", ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥ ‡∏Ø‡∏•‡∏Ø
</context>

<scope_schema>
<‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£

<‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏≤‡∏ä‡∏≤
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô:
    - overall, bleeding, pain, wound healing
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - overall, drinking straw, alcohol, workout, food, oral hygiene
</scope_schema>

<examples_in_scope>
- ‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ
- ‡πÅ‡∏ú‡∏•‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô
- ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°
- ‡∏¢‡∏≤‡∏ä‡∏≤‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≤‡∏ô‡∏Å‡∏µ‡πà‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
- ‡∏¢‡∏≤‡∏ä‡∏≤‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏§‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà
</examples_in_scope>

<examples_out_of_scope>
- ‡∏ü‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏≠‡∏∞‡πÑ‡∏£
- ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
- ‡∏à‡∏∞‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏î‡∏µ
- ws;vgg?
- üôÉüôÉüôÉ
</examples_out_of_scope>

<guideline>
‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö Reasoning:
1. ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô" ‚Üí ‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
2. ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" ‚Üí ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
3. ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå" ‚Üí ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤
‚Üí ‡∏™‡∏£‡∏∏‡∏õ: ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (false)

‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô:
- ‡∏ñ‡πâ‡∏≤ **‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÑ‡∏î‡πâ** ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÉ‡∏ô `<scope_schema>` ‚Üí `out_of_domain: false`
- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏£‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢ ‚Üí `out_of_domain: true`
- ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö "‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô", "‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", "‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ", ‡∏´‡∏£‡∏∑‡∏≠ "‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô" ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ out_of_domain: true
- ‡∏´‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ out_of_domain: true
**‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏î‡∏≤ ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏£‡∏á ‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô**
- ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡∏û‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï: "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô", "‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î", "‡∏¢‡∏≤‡∏ä‡∏≤", "‡∏õ‡∏ß‡∏î", "‡πÅ‡∏ú‡∏•", "‡πÄ‡∏•‡∏∑‡∏≠‡∏î", "‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥", "‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå", "‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£" ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï
</guideline>

<output_format>
{
  "out_of_domain": true | false,
  "reason": "‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô' ‡πÅ‡∏•‡∏∞ '‡∏¢‡∏≤‡∏ä‡∏≤' ‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"
}
</output_format>
<examples>                      
[IN] ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå  
[OUT] {"out_of_domain": false, "reason": "‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô' ‡πÅ‡∏•‡∏∞ '‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥' ‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"}
[IN] ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏û‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå  
[OUT] {"out_of_domain": false, "reason": "‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏à‡∏∂‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï"}
                      
‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥:
1. ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
2. ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å `<criteria>`, `<scope_schema>`, `<guideline>` ‡πÅ‡∏•‡∏∞ `<examples>` ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤
3. ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏ß‡∏¢ JSON ‡∏ï‡∏≤‡∏° `<output_format>` ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°                      
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏≤‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô reasoning ‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <output_format>"
        )
    ])
    chain = prompt | llm
    return chain.invoke({"user_query": user_query})


# ‚úÖ Step 2: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
def check_clarity(user_query: str) -> ClarificationResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=ClarificationResult,
        temperature=0.1
    )

    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢‡∏ß‡πà‡∏≤ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ô‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢

‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:
- `<task>` ‡∏Ñ‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏±‡πâ‡∏ô (Chain of Thought) ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ï‡∏≤‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- `<criteria>` ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤ `clarification_needed: true` ‡∏´‡∏£‡∏∑‡∏≠ `false` ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏à‡∏≤‡∏Å task ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ç‡πâ‡∏≠
<task>
‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏ö‡∏ö Chain of Thought (CoT) ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ (short-circuit evaluation):

‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö ‡∏´‡∏≤‡∏Å‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î "‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á (false)" ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ  
‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
  {"clarification_needed": true, "clarification_reason": "<‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô>"}
1. ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏≠‡∏∞‡πÑ‡∏£, ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£, ‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°, ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏£, ‡∏Ñ‡∏ß‡∏£‡πÑ‡∏´‡∏°, ‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á  
   - ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà‚Äù, ‚Äú‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‚Äù ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°  
   ‚Üí ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‚Üí ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô  
   ‚Üí clarification_reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°"

2. ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á **‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£** ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô, ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î, ‡∏Ç‡∏π‡∏î‡∏´‡∏¥‡∏ô‡∏õ‡∏π‡∏ô, ‡∏≠‡∏∏‡∏î‡∏ü‡∏±‡∏ô, ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô, ‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å, ‡∏ï‡∏±‡∏î‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å ‡∏Ø‡∏•‡∏Ø  
   - ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡πÅ‡∏Ñ‡πà‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ó‡∏≥‡∏ü‡∏±‡∏ô", "‡∏´‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏´‡∏°‡∏≠", "‡∏ï‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ö‡πâ‡∏≤‡∏ô", "‡∏ï‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏ã‡∏µ‡πà‡∏ô‡∏±‡πâ‡∏ô‡∏´‡∏•‡∏∏‡∏î" ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤ **‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡πÉ‡∏î** ‚Üí ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ **‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£**  
   - ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î‡∏î‡∏π‡∏î‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°", "‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°" ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ß‡πà‡∏≤‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠  
   ‚Üí ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí ‡∏´‡∏¢‡∏∏‡∏î  
   ‚Üí clarification_reason: "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î ‡∏Ø‡∏•‡∏Ø"

3. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏™‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏ü‡∏±‡∏ô ‡πÄ‡∏´‡∏á‡∏∑‡∏≠‡∏Å ‡πÄ‡∏à‡πá‡∏ö ‡∏õ‡∏ß‡∏î ‡πÅ‡∏ú‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡∏¢‡∏≤‡∏ä‡∏≤ ‡∏ö‡∏ß‡∏° ‡πÄ‡∏¢‡πá‡∏ö‡πÅ‡∏ú‡∏• ‡∏£‡∏≤‡∏Å‡∏ü‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏ü‡∏±‡∏ô  
   - ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó  
   - ‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏õ‡∏ß‡∏î‚Äù, ‚Äú‡∏ä‡∏≤‚Äù, ‚Äú‡πÅ‡∏™‡∏ö‚Äù, ‚Äú‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‚Äù ‚Üí ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏ú‡∏π‡∏Å‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏õ‡∏≤‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   ‚Üí ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ‚Üí ‡∏´‡∏¢‡∏∏‡∏î  
   ‚Üí clarification_reason: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°"

4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà  
   - ‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á ‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö 3 ‡∏Ç‡πâ‡∏≠‡∏Ç‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô (‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° + ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ + ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó) ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°  
   - ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Ñ‡∏ß‡∏£‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ", "‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á", ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡∏≤‡∏î‡∏Ñ‡∏≥‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏ö‡∏≠‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‚Üí ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠  
   ‚Üí ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‚Üí ‡∏´‡∏¢‡∏∏‡∏î  
   ‚Üí clarification_reason: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥"

‡∏´‡∏≤‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 4 ‡∏Ç‡πâ‡∏≠ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ß‡πà‡∏≤:
  {"clarification_needed": false}
</task>

<criteria>
- ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡πÉ‡∏î ‚Äú‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‚Äù ‚Üí ‡∏ï‡∏≠‡∏ö:
  {
    "clarification_needed": true,
    "clarification_reason": "<‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö>"
  }

- ‡∏ñ‡πâ‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á 4 ‡∏Ç‡πâ‡∏≠ ‚Üí ‡∏ï‡∏≠‡∏ö:
  {
    "clarification_needed": false
  }
</criteria>


‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Ñ‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤ clarification_needed:
- [IN] ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
- [REASONING] ‡∏Ñ‡∏∑‡∏≠ ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏ó‡∏±‡πâ‡∏á 4 ‡∏Ç‡πâ‡∏≠ (‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°, ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£, ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠)
- [OUT] ‡∏Ñ‡∏∑‡∏≠ ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ clarification_needed ‡πÅ‡∏•‡∏∞ reason

<examples>
[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏õ‡∏ß‡∏î"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ("‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô")
2. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡∏õ‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
3. ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏Å‡∏£‡∏≤‡∏°)
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
[OUT] {"clarification_needed": false, "reason": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô"}

[IN] "‡∏¢‡∏±‡∏á‡πÄ‡∏à‡πá‡∏ö‡∏≠‡∏¢‡∏π‡πà"
[REASONING]
1. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ö‡∏≠‡∏Å‡πÄ‡∏•‡πà‡∏≤
2. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
3. ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
[OUT] {"clarification_needed": true, "reason": "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£"}

[IN] "‡∏¢‡∏≤‡∏ä‡∏≤‡∏´‡∏°‡∏î‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡∏Ñ‡∏∞"  
[REASONING]  
1.‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°  
2.‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° ("‡∏¢‡∏≤‡∏ä‡∏≤")  
3.‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£  
4.‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠  
[OUT] {"clarification_needed": true, "reason": "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô ‡∏ú‡πà‡∏≤‡∏ü‡∏±‡∏ô‡∏Ñ‡∏∏‡∏î ‡∏Ø‡∏•‡∏Ø"}
                      
[IN] "‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏î‡∏µ"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏°
2. ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£)
3. ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏≠‡∏∞‡πÑ‡∏£
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠
[OUT] {"clarification_needed": true, "reason": "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£"}

[IN] "‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á"
[REASONING]
1. ‡∏°‡∏µ‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ñ‡∏≤‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ)
2. ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏° (‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
3. ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô)
4. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
[OUT] {"clarification_needed": false, "reason": "‡πÄ‡∏à‡∏ï‡∏ô‡∏≤‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡πÅ‡∏•‡∏∞‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏ö"}
</examples>

<format>
‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON:
{
  "clarification_needed": true | false,
  "reason": "‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•"
}
</format>

"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° <format>"
        )
    ])
    chain = prompt | llm
    return chain.invoke({"user_query": user_query})

# ‚úÖ Step 3: ‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
def classify_categories(user_query: str) -> CategoryResult:
    llm = get_together_llm(
        model=TOGETHER_MODEL,
        structured_output_schema=CategoryResult,
        temperature=0.1
    )
    prompt = ChatPromptTemplate.from_messages([
        SystemMessage(content="""
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ï‡∏Å‡∏£‡∏£‡∏°  
‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å (`category_level_1`) ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (`category_level_2`) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à (confidence)

<‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö (category_level_1)>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£

<‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (category_level_2) ‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å>
- ‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤
- ‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô:
    - overall
    - bleeding
    - pain
    - wound healing
- ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£:
    - overall
    - drinking straw
    - alcohol
    - workout
    - food
    - oral hygiene

<category_level_2 definitions>
- ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ä‡∏≤: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ä‡∏ô‡∏¥‡∏î ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏≠‡∏á‡∏§‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏≤‡∏ä‡∏≤
- overall (‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô): ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏£‡∏ß‡∏° ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏£‡∏û‡∏ö‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÉ‡∏î
- bleeding: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏∑‡∏≠‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏´‡∏• ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î
- pain: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏ß‡∏î ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢ ‡∏Å‡∏¥‡∏ô‡∏¢‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
- wound healing: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÅ‡∏ú‡∏•‡∏´‡∏≤‡∏¢ ‡∏ü‡∏∑‡πâ‡∏ô‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ú‡∏•‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà ‡∏´‡∏≤‡∏¢‡∏ä‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- overall (‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£): ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£
- drinking straw: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≠‡∏î
- alcohol: ‡∏Å‡∏≤‡∏£‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå
- workout: ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢
- food: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏¥‡∏ô‡πÑ‡∏î‡πâ/‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Ç‡πá‡∏á ‡πÄ‡∏ú‡πá‡∏î ‡∏£‡πâ‡∏≠‡∏ô
- oral hygiene: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å ‡πÅ‡∏õ‡∏£‡∏á‡∏ü‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ö‡πâ‡∏ß‡∏ô‡∏õ‡∏≤‡∏Å
</category_level_2 definitions>

<‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î>
- ‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° 1 ‡∏Ç‡πâ‡∏≠ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
- confidence ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 0.0 - 1.0

<format>
{
  "category_level_1": [
    {"category": "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏•‡∏±‡∏Å", "confidence": 0.0 - 1.0},
    ...
  ],
  "category_level_2": [
    {"subcategory": "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢", "confidence": 0.0 - 1.0},
    ...
  ]
}
</format>

<‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á>
[IN] ‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏ß‡∏î‡∏°‡∏≤‡∏Å ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?
[OUT]
{
  "category_level_1": [
    {"category": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "confidence": 0.93},
    {"category": "‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏±‡∏ß‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏≤‡∏£", "confidence": 0.91}
  ],
  "category_level_2": [
    {"subcategory": "pain", "confidence": 0.91},
    {"subcategory": "food", "confidence": 0.88}
  ]
}
[IN] ‡πÅ‡∏ú‡∏•‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡∏™‡∏ô‡∏¥‡∏ó‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏µ‡πà‡∏ß‡∏±‡∏ô?
[OUT]
{
  "category_level_1": [{"category": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "confidence": 0.91}],
  "category_level_2": [{"subcategory": "wound healing", "confidence": 0.90}]
}
[IN] ‡πÅ‡∏ú‡∏•‡∏ñ‡∏≠‡∏ô‡∏ü‡∏±‡∏ô‡∏´‡∏≤‡∏¢‡∏ô‡∏≤‡∏ô‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô
[OUT]
{
  "category_level_1": [{"category": "‡∏≠‡∏≤‡∏Å‡∏≤‡∏£/‡∏†‡∏≤‡∏ß‡∏∞‡πÅ‡∏ó‡∏£‡∏Å‡∏ã‡πâ‡∏≠‡∏ô", "confidence": 0.90}],
  "category_level_2": [{"subcategory": "wound healing", "confidence": 0.89}]
}
"""),
        HumanMessagePromptTemplate.from_template(
            "‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°: {user_query}\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏ï‡∏≤‡∏° schema ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î"
        )
    ])
    chain = prompt | llm
    raw_result = chain.invoke({"user_query": user_query})
    filtered_result = filter_invalid_categories(raw_result)
    return filtered_result

# ‚úÖ ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô pipeline
def run_classification_pipeline(state: AgentState) -> AgentState:
    latency_info = {}

    query = state.user_query.lower()

    # ‚ú® Step 0: Intent Detection
    print("üëÄ Step 0: Intent Detection (Greeting/Farewell)")
    if any(w in query for w in ["hi", "hello", "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ"]):
        print("‚úÖ Detected Greeting Intent")
        state.classification_result.intent = "greeting"
        return state

    if any(w in query for w in ["bye", "goodbye", "‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏ô", "‡∏ö‡πä‡∏≤‡∏¢‡∏ö‡∏≤‡∏¢"]):
        print("‚úÖ Detected Farewell Intent")
        state.classification_result.intent = "farewell"
        return state

    # ‚ú® ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô flow ‡πÄ‡∏î‡∏¥‡∏°
    # üîç Step 1: Clarity Check
    print("üîç Step 1: Clarity Check")
    start = time.perf_counter()
    clarity_result = check_clarity(state.user_query)
    print("‚úÖ Clarity Result:", clarity_result)
    latency_info["clarification"] = round(time.perf_counter() - start, 3)
    latency_info["tokens_clarification"] = count_tokens(state.user_query, model=TOGETHER_MODEL)
    state.classification_result.clarification_needed = clarity_result.clarification_needed
    state.classification_result.clarification_reason = clarity_result.reason
    if state.should_terminate():
        state.latency = latency_info
        return state

    # üö¶ Step 2: Out-of-Domain Check
    print("üö¶ Step 2: Out-of-Domain Check")
    start = time.perf_counter()
    ood_result = check_out_of_domain(state.user_query)
    print("‚úÖ Out-of-Domain Result:", ood_result)
    if ood_result is None or ood_result.out_of_domain is None:
        state.classification_result.out_of_domain = True
        state.response = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ"
        state.latency = latency_info
        return state
    latency_info["out_of_domain"] = round(time.perf_counter() - start, 3)
    latency_info["tokens_out_of_domain"] = count_tokens(state.user_query, model=TOGETHER_MODEL)
    state.classification_result.out_of_domain = ood_result.out_of_domain
    state.classification_result.out_of_domain_reason = ood_result.reason
    if state.should_terminate():
        state.latency = latency_info
        return state

    # üìä Step 3: Category Classification
    print("üìä Step 3: Category Classification")
    start = time.perf_counter()
    category_result = classify_categories(state.user_query)
    latency_info["classification"] = round(time.perf_counter() - start, 3)
    latency_info["tokens_classification"] = count_tokens(state.user_query, model=TOGETHER_MODEL)
    state.classification_result.category_level_1 = category_result.category_level_1
    state.classification_result.category_level_2 = category_result.category_level_2

    state.latency = latency_info
    return state

